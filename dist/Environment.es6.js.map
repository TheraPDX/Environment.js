{"version":3,"file":"Environment.es6.js","sources":["../lib/Environment.js"],"sourcesContent":["const _ = require('underscore');\nconst later = require('later');\nconst EventEmitter = require('events');\n\nclass Environment extends EventEmitter {\n  /**\n   * Constructs a new Thing object. A Thing is an extension of [node's built-in \n     EventEmitter class](https://nodejs.org/api/events.html).\n   * @param {Object} config a javascript object containing metadata, properties, events, and actions\n   * @return     A new thing object\n  */\n  constructor(config) {\n    super();\n\n    if (!config) {\n      throw new Error('Environment.js requires an config object.');\n    } else {\n      _.extend(this, config);\n    }\n\n    // TODO: register things.\n    this.registerThings();\n  }\n\n  /**\n   * Registers things.\n   */\n  registerThings () {\n\n  }\n\n  /**\n   * Starts any scheduled actions.\n   * Todo: should also throw errors if actions don't have IDs or functions.\n   */\n  registerActions () {\n    this.scheduledActions = [];\n\n    for (var action in this.actions) {\n      // TODO:\n      // Through error if no id is assigned?\n      // or perhaps generate id?\n      var actionId = this.actions[action].id;\n      \n      if (!_.isUndefined(action)) {\n        this.startAction(this.actions[action]);\n      }\n    }\n  }\n\n  /**\n   * Starts listeners and scheduled events.\n   * Todo: this needs better testing.\n   */\n  registerEvents () {\n    this.scheduledEvents = [];\n\n    // Check top level thing model for events.\n    if (!_.isUndefined(this.events)) {\n      for (var event in this.events) {\n        event = this.events[event];\n        \n        if (!_.isUndefined(event.schedule)) {\n          this.scheduleEvent(event);\n        }\n\n        if (!_.isUndefined(event.on)) {\n          this.on(event.on, () => {\n            event.function();\n          });\n        }\n      }\n    }\n  }\n\n  registerProperties () {\n    if (!_.isUndefined(this.properties)) {\n      for (var property in this.properties) {\n        // If the property is a function we initialize it.\n        if (typeof this.properties[property] === 'function') {\n          // Note this function should return property value.\n          this.properties[property] = this.properties[property]()\n        }\n      }\n    }\n  }\n\n  /**\n   * Get component object (an action or event for example) based on the id\n   * @param {String} ID  The id of the component object you want.\n   * @returns {Object}\n   */\n  getComponentByID (ID) {\n    // Check top level component\n    if (this.id === ID) {\n      return this;\n    }\n\n    // Check action and event components\n    else {\n      return _.findWhere(this.actions, {id: ID}) || _.findWhere(this.events, {id: ID});\n    }\n  }\n\n  /**\n   * Update a property based on a component ID.\n   * @param {String} componentID The id of the component to change the property of.\n   * @param {String} property The property of the component to be update.\n   * @param {String} value The value to update the property to.\n   */\n  updateComponentProperty (componentID, property, value) {\n    var component = this.getComponentByID(componentID);\n    return component[property] = value;\n  }\n\n  /**\n   * Update a property based on a component ID.\n   * @param {String} property The property of the component to be update.\n   * @param {String} value The value to update the property to.\n   */\n  setProperty (property, value) {\n    return this.properties[property] = value;\n  }\n\n  /* Get a property by name.\n   * @param {String} property\n   * @returns {String} property value.\n   */\n  getProperty (property) {\n    return this.properties[property];\n  }\n\n  /**\n   * Calls a registered action, emits event if the the action has an 'event'\n   * property defined. Updates the state if the action has an 'updateState'\n   * property specified.\n   * @param      {String}  actionId The id of the action to call.\n   * @param      {Object}  options Optional, options to call with the function.\n   */\n  callAction (actionId, options) {\n    try {\n      var action = this.getComponentByID(actionId);\n\n      if (!_.isUndefined(options)) {\n        var output = action.function(options);\n      }\n      else {\n        var output = action.function();\n      }\n      this.emit(actionId);\n\n      // We return any returns of called functions for testing.\n      if (!_.isUndefined(output)) {\n        return output;\n      }\n    }\n    catch (error) {\n      // If there is an error we emit an error.\n      return this.emit('error', error);\n    }\n\n  }\n\n  /**\n   * Starts a reoccurring action if a schedule property is defined.\n   * @param {Object} action An action object.\n   */\n  startAction (action) {\n    var schedule = later.parse.text(action.schedule);\n    var scheduledAction = later.setInterval(()=> {this.callAction(action.id);}, schedule);\n    this.scheduledActions.push(scheduledAction);\n    return scheduledAction;\n  }\n\n  /**\n   * Starts a reoccurring event if a schedule property is defined.\n   * @param {Object} event An event object.\n   */\n  scheduleEvent (event) {\n    var schedule = later.parse.text(event.schedule);\n    var scheduledEvent = later.setInterval(()=> {this.callEvent(event.id);}, schedule);\n    this.scheduledEvents.push(scheduledEvent);\n    return scheduledEvent;\n  }\n};\n\nexport default Environment;\n"],"names":[],"mappings":"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"}